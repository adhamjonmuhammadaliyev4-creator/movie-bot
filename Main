import os
import sqlite3
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    filters,
    ContextTypes
)

load_dotenv()

TOKEN = os.getenv("BOT_TOKEN")
ADMIN_ID = int(os.getenv("ADMIN_ID"))

CHANNELS = ["@kanal1", "@kanal2"]

# Database
conn = sqlite3.connect("database.db", check_same_thread=False)
cursor = conn.cursor()

cursor.execute("""
CREATE TABLE IF NOT EXISTS movies(
code TEXT PRIMARY KEY,
file_id TEXT,
downloads INTEGER DEFAULT 0
)
""")
conn.commit()

async def check_subscription(user_id, bot):
    for channel in CHANNELS:
        member = await bot.get_chat_member(channel, user_id)
        if member.status in ["left", "kicked"]:
            return False
    return True

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("‚úÖ Tekshirish", callback_data="check")]
    ]

    await update.message.reply_text(
        "üé¨ Kino botga xush kelibsiz!\nKod yozing:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user_id = query.from_user.id

    if await check_subscription(user_id, context.bot):
        await query.message.reply_text("‚úÖ Kino kodni yozing")
    else:
        await query.message.reply_text("‚ùå Kanallarga a'zo bo‚Äòling")

async def message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    user_id = update.effective_user.id

    # Admin kino qo‚Äòshish
    if user_id == ADMIN_ID and text.startswith("add"):
        parts = text.split()

        if len(parts) == 3:
            code = parts[1]
            file_id = parts[2]

            cursor.execute(
                "INSERT OR REPLACE INTO movies VALUES (?,?,0)",
                (code, file_id)
            )
            conn.commit()

            await update.message.reply_text("‚úÖ Kino qo‚Äòshildi")
            return

    # Kino olish
    cursor.execute(
        "SELECT file_id FROM movies WHERE code=?",
        (text,)
    )

    result = cursor.fetchone()

    if result:
        await update.message.reply_video(result[0])
    else:
        await update.message.reply_text("‚ùå Kino topilmadi")

app = ApplicationBuilder().token(TOKEN).build()

app.add_handler(CommandHandler("start", start))
app.add_handler(CallbackQueryHandler(button))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, message_handler))

app.run_polling()
